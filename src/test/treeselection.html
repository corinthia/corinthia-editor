<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<title>Tree Selection Test</title>
<style type="text/css">
    body { -webkit-user-select: none }
</style>
<script language="javascript">
var CONTAINER_ELEMENTS = new Object();

CONTAINER_ELEMENTS["#document"] = true;
CONTAINER_ELEMENTS["HTML"] = true;
CONTAINER_ELEMENTS["BODY"] = true;
CONTAINER_ELEMENTS["UL"] = true;
CONTAINER_ELEMENTS["OL"] = true;
CONTAINER_ELEMENTS["LI"] = true;
CONTAINER_ELEMENTS["TABLE"] = true;
CONTAINER_ELEMENTS["THEAD"] = true;
CONTAINER_ELEMENTS["TFOOT"] = true;
CONTAINER_ELEMENTS["TBODY"] = true;
CONTAINER_ELEMENTS["TR"] = true;
CONTAINER_ELEMENTS["TH"] = true;
CONTAINER_ELEMENTS["TD"] = true;
CONTAINER_ELEMENTS["COL"] = true;

var PARAGRAPH_ELEMENTS = new Object();

PARAGRAPH_ELEMENTS["P"] = true;
PARAGRAPH_ELEMENTS["DIV"] = true;
PARAGRAPH_ELEMENTS["H1"] = true;
PARAGRAPH_ELEMENTS["H2"] = true;
PARAGRAPH_ELEMENTS["H3"] = true;
PARAGRAPH_ELEMENTS["H4"] = true;
PARAGRAPH_ELEMENTS["H5"] = true;
PARAGRAPH_ELEMENTS["H6"] = true;

var HEADING_ELEMENTS = new Object();

HEADING_ELEMENTS["H1"] = true;
HEADING_ELEMENTS["H2"] = true;
HEADING_ELEMENTS["H3"] = true;
HEADING_ELEMENTS["H4"] = true;
HEADING_ELEMENTS["H5"] = true;
HEADING_ELEMENTS["H6"] = true;




function debug(str)
{
    console.log(str);
}

var INDENTATION = 40;
var SPACING = 4;
var LABEL_WIDTH = 200;
var LABEL_HEIGHT = 10;



var rootNode = null;
var nextNodeId = 0;

function createDiv()
{
    var node = document.createElement("DIV");
    node.setAttribute("id",nextNodeId++);
    return node;
}

function addNodeAtDepth(depth)
{
    var parent = rootNode;
    while ((depth > 0) && (parent.lastChild != null)) {
        parent = parent.lastChild;
        depth--;
    }
    while (depth > 0) {
        var temp = createDiv();
        parent.appendChild(temp);
        depth--;
    }
    var temp = createDiv();
    parent.appendChild(temp);
}

function layout(node,showLabel)
{
    for (var child = node.firstChild; child != null; child = child.nextSibling)
        layout(child,showLabel);

    node.style.border = "1px solid black";

    node.style.paddingLeft = INDENTATION+"px";
//    node.style.paddingTop = SPACING+"px";
//    node.style.paddingBottom = SPACING+"px";
    node.style.paddingRight = SPACING+"px";
    node.style.marginTop = SPACING+"px";
    node.style.marginBottom = SPACING+"px";

    if (node.firstChild == null) {
        node.style.height = LABEL_HEIGHT+"px";
    }

//    node.appendChild(document.createTextNode("X"));
}

var addedLabels = false;

function addLabels(node)
{
    for (var child = node.firstChild; child != null; child = child.nextSibling)
       addLabels(child);

    if (node.nodeType == Node.ELEMENT_NODE) {
        var label = document.createElement("DIV");
        var rect = node.getBoundingClientRect();
        label.style.position = "absolute";
        label.style.left = rect.left+"px";
        label.style.top = rect.top+"px";
        label.style.font = "8pt sans-serif";
        label.appendChild(document.createTextNode(node.getAttribute("id")));
        document.body.appendChild(label);
    }
}

var dragging = false;
var selectionRange = null;

function indexOfNodeIn(node,parent)
{
    var index = 0;
    for (var child = parent.firstChild; child != null; child = child.nextSibling) {
        if (child == node)
            return index;
        index++;
    }
    return null;
}

function adjustPosition(position,end)
{
    var parent = position.node.parentNode;
    if (parent != null) {
        var index = indexOfNodeIn(position.node,parent);
        if (index == null)
            throw new Error("Could not get index");

        if (!end && (index > 0)) {
            position.node = parent;
            position.offset = index;
        }
        else if (end && (index < parent.childNodes.length-1)) {
            position.node = parent;
            position.offset = index+1;
        }
    }
}

function updateSelectionDisplay()
{
    clearHighlightsRecursive(rootNode);

    if (selectionRange != null) {

        var tempRange = selectionRange.copy();
        adjustPosition(tempRange.start,false);
        adjustPosition(tempRange.end,true);
        tempRange.convertToOffsetFree();
        if (selectionRange.start.node != tempRange.start.node) {
            debug("start.node mismatch (expected "+
                  selectionRange.start.node.getAttribute("id")+", got "+
                  tempRange.start.node.getAttribute("id")+")");
        }
        if (selectionRange.start.offset != tempRange.start.offset) {
            debug("start.offset mismatch");
        }
        if (selectionRange.end.node != tempRange.end.node) {
            debug("end.node mismatch (expected "+
                  selectionRange.end.node.getAttribute("id")+", got "+
                  tempRange.end.node.getAttribute("id")+")");
        }
        if (selectionRange.end.offset != tempRange.end.offset) {
            debug("end.offset mismatch");
        }

        var useRange = selectionRange.copy();

        useRange.start.node.style.border = "1px solid lime";
        useRange.end.node.style.border = "1px solid red";

        var nodes = useRange.getSelectedNodes();
//        debug("**** nodes.length = "+nodes.length);
        for (var i = 0; i < nodes.length; i++) {
            if (nodes[i].nodeType == Node.ELEMENT_NODE) {
                nodes[i].style.backgroundColor = "#c0c0c0";
//                nodes[i].style.border = "1px solid blue";
            }
        }
    }

    function clearHighlightsRecursive(node)
    {
        if (node.nodeType == Node.ELEMENT_NODE) {
            node.style.backgroundColor = "white";
            node.style.border = "1px solid black";
            for (var child = node.firstChild; child != null; child = child.nextSibling)
                clearHighlightsRecursive(child);
        }
    }
}

function mousedown(event)
{
    if (!addedLabels) {
        addLabels(rootNode);
        addedLabels = true;
    }
    if ((event.target.nodeName == "DIV") && (event.target.firstChild == null)) {
        selectionRange = new Range(new Position(event.target,0),
                                   new Position(event.target,0));
    }
    else {
        selectionRange = null;
    }
    updateSelectionDisplay();
    dragging = true;
}

function mousemove(event)
{
    if (dragging) {
        var node = event.target;
        if ((node.nodeName == "DIV") && (node.firstChild == null)) {
            if (selectionRange == null) {
                selectionRange = new Range(new Position(node,0),
                                           new Position(node,0));
            }
            else {
                selectionRange.end = new Position(node,node.childNodes.length);
            }
//            debug("selection: "+selectionRange.start.node.getAttribute("id")+
//                  " - "+selectionRange.end.node.getAttribute("id"));
            updateSelectionDisplay();
        }
    }
}

function mouseup(event)
{
    dragging = false;
}

function loaded()
{
    rootNode = createDiv();

    for (var i = 0; i < 4; i++) {
        addNodeAtDepth(0);
        addNodeAtDepth(0);
        addNodeAtDepth(1);
        addNodeAtDepth(1);
        addNodeAtDepth(2);
        addNodeAtDepth(2);
        addNodeAtDepth(3);
        addNodeAtDepth(3);
        addNodeAtDepth(3);
        addNodeAtDepth(2);
        addNodeAtDepth(2);
        addNodeAtDepth(1);
        addNodeAtDepth(1);
        addNodeAtDepth(0);
    }

    layout(rootNode);
    document.body.appendChild(rootNode);

    document.onmousedown = mousedown;
    document.onmousemove = mousemove;
    document.onmouseup = mouseup;
}
</script>
<script language="javascript" src="../traversal.js"></script>
<script language="javascript" src="../Position.js"></script>
<script language="javascript" src="../Range.js"></script>

</head>

<body onload="loaded()">
<h1>Tree Selection Test</h1>

</body>
</html>
