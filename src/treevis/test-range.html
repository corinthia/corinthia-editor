<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<!-- Copyright (c) 2011-2012 UX Productivity Pty Ltd. All rights reserved. -->
<html>
<head>
<link rel="stylesheet" type="text/css" href="TreeView.css" />
<style type="text/css">

body { -webkit-user-select: none }

</style>
<script type="text/javascript" src="../DOM.js"></script>
<script type="text/javascript" src="../UndoManager.js"></script>
<script type="text/javascript" src="../NodeSet.js"></script>
<script type="text/javascript" src="../Position.js"></script>
<script type="text/javascript" src="../Range.js"></script>
<script type="text/javascript" src="../traversal.js"></script>
<script type="text/javascript" src="../util.js"></script>

<script type="text/javascript" src="TreeView.js"></script>
<script type="text/javascript" src="StepController.js"></script>
<script type="text/javascript" src="Slider.js"></script>
<script type="text/javascript" src="BoundingPolygons.js"></script>
<script type="text/javascript">

// http://station.woj.com/2010/02/javascript-random-seed.html
//var randomSeed = new Date().getTime();
//var randomSeed = 1328615295137;
//var randomSeed = 1328725991396;
var randomSeed = 1328744506051;
debug("randomSeed = "+randomSeed);
function random()
{
    randomSeed = (randomSeed*9301+49297) % 233280;
    return randomSeed/(233280.0);
}

var SVG_NAMESPACE = "http://www.w3.org/2000/svg";
var SVG_VERSION = "1.1";

function debug(str)
{
    console.log(str);
}

function buildTree(doc,parent,depth,nchildren)
{
    if (depth > 0) {
        var count = Math.floor(nchildren*random());
        for (var i = 0; i < count; i++) {

            UndoManager.newGroup();
            var child = doc.createElement("DIV");
            child.setAttribute("class","treenode");
            parent.appendChild(child);


            buildTree(doc,child,depth-1,nchildren);
        }
    }
}

function removeTextNodes(node)
{
    var next;
    for (var child = node.firstChild; child != null; child = next) {
        next = child.nextSibling;
        if (child.nodeType == Node.TEXT_NODE) {
            node.removeChild(child);
        }
        else {
            removeTextNodes(child);
        }
    }
}

function programmaticTree()
{
    var root = document.createElement("DIV");
    root.style.display = "none";
    document.body.appendChild(root);
    DOM.addUndoListeners(root);
    UndoManager.group(buildTree,document,root,6,4);
//    buildTree(document,root,5,5);
    return root;
}

var dragging = false;
var state = { set: null, start: null, end: null };
var treeView = null;
var range = null;

function updateSelection(position)
{
    if (range == null) {
        range = new Range(position.node,position.offset,position.node,position.offset);
    }
    else {
        range = new Range(range.start.node,range.start.offset,
                                position.node,position.offset);
    }
    state.start = range.start;
    state.end = range.end;
    var nodes = range.getAllNodes();
    var set = new NodeSet();
    for (var i = 0; i < nodes.length; i++)
        set.add(nodes[i]);
    state.set = set;
    treeView.update();
}

function mouseDownPosition(position)
{
    dragging = true;
    range = null;
    updateSelection(position);
}

function mouseUpPosition(position)
{
    dragging = false;
}

function mouseOverPosition(position)
{
    if (dragging)
        updateSelection(position);
}

function mouseMovePosition(position)
{
}

function mouseOutPosition(position)
{
}

function clickPosition(position)
{
}

function main()
{
    var root = programmaticTree();
//    var root = declarativeTree();

//    preorderTraversal(root);
//    traversePositions(root);

    var svg = document.createElementNS(SVG_NAMESPACE,"svg");
    svg.setAttribute("version","1.1");
    document.body.appendChild(svg);

    treeView = new TreeView(root);
    svg.appendChild(treeView.element);
    treeView.update();

    treeView.selectionMode = TreeView.POSITION_SELECTION;
    treeView.onMouseDownPosition = mouseDownPosition;
    treeView.onMouseUpPosition = mouseUpPosition;
    treeView.onMouseOverPosition = mouseOverPosition;
    treeView.onMouseMovePosition = mouseMovePosition;
    treeView.onMouseOutPosition = mouseOutPosition;
    treeView.onClickPosition = clickPosition;

    UndoManager.monitorObject(state);
}


</script>
</head>

<body onload="main()" style="margin: 0">
</body>
</html>
