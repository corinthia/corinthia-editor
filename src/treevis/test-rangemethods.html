<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<!-- Copyright (c) 2011-2012 UX Productivity Pty Ltd. All rights reserved. -->
<html>
<head>
<link rel="stylesheet" type="text/css" href="TreeView.css" />
<style type="text/css">

body { -webkit-user-select: none }

</style>
<script type="text/javascript" src="../DOM.js"></script>
<script type="text/javascript" src="../UndoManager.js"></script>
<script type="text/javascript" src="../NodeSet.js"></script>
<script type="text/javascript" src="../Position.js"></script>
<script type="text/javascript" src="../Range.js"></script>
<script type="text/javascript" src="../traversal.js"></script>
<script type="text/javascript" src="../util.js"></script>
<script type="text/javascript" src="../tests/dom/RangeTest.js"></script>

<script type="text/javascript" src="TreeView.js"></script>
<script type="text/javascript" src="StepController.js"></script>
<script type="text/javascript" src="Slider.js"></script>
<script type="text/javascript" src="BoundingPolygons.js"></script>
<script type="text/javascript">

// http://station.woj.com/2010/02/javascript-random-seed.html
//var randomSeed = new Date().getTime();
//var randomSeed = 1328615295137;
//var randomSeed = 1328725991396;
var randomSeed = 1328744506051;
debug("randomSeed = "+randomSeed);
function random()
{
    randomSeed = (randomSeed*9301+49297) % 233280;
    return randomSeed/(233280.0);
}

var SVG_NAMESPACE = "http://www.w3.org/2000/svg";
var SVG_VERSION = "1.1";

function debug(str)
{
    console.log(str);
}

var dragging = false;
var state = { startPosition: null, endPosition: null,
              beginning: null, middle: null, end: null, all: null, outermost: null };
var treeView = null;
var range = null;

function addNodesToSetRecursive(set,node)
{
    set.add(node);
    for (var child = node.firstChild; child != null; child = child.nextSibling)
        addNodesToSetRecursive(set,child);
}

function updateForPosition(position)
{
    if (range == null) {
        range = new Range(position.node,position.offset,position.node,position.offset);
    }
    else {
        range = new Range(range.start.node,range.start.offset,
                                position.node,position.offset);
    }
    state.startPosition = range.start;
    state.endPosition = range.end;
    var info = new Object();
//    var nodes = range.getOutermostNodes(info);
    var nodes = getOutermostNodesSimple(range,info);

    if (info.beginning == null) {
        var all = new NodeSet();
        nodes.forEach(function(node) { addNodesToSetRecursive(all,node); });
        state.all = all;

        var outermost = new NodeSet();
        nodes.forEach(function (node) { outermost.add(node); });
        state.outermost = outermost;
    }
    else {
        var beginning = new NodeSet();
        var middle = new NodeSet();
        var end = new NodeSet();
        info.beginning.forEach(function(node) { addNodesToSetRecursive(beginning,node); });
        info.middle.forEach(function(node) { addNodesToSetRecursive(middle,node); });
        info.end.forEach(function(node) { addNodesToSetRecursive(end,node); });
        state.beginning = beginning;
        state.middle = middle;
        state.end = end;
    }

    treeView.update();
}

function updateForNode(node)
{
    var offset = getOffsetOfNodeInParent(node);
    updateForPosition(new Position(node.parentNode,offset));
}

function mouseDownPosition(position)
{
    dragging = true;
    range = null;
    updateForPosition(position);
}

function mouseUpPosition(position)
{
    dragging = false;
}

function mouseOverPosition(position)
{
    if (dragging)
        updateForPosition(position);
}

function mouseDownNode(node)
{
    dragging = true;
    range = null;
    updateForNode(node);
}

function mouseUpNode(node)
{
    dragging = false;
}

function mouseOverNode(node)
{
    if (dragging)
        updateForNode(node);
}

function layout()
{
    var xOffset = window.innerWidth/2 - treeView.width/2;
    var yOffset = window.innerHeight/2 - treeView.height/2;
    treeView.setCoords(xOffset,yOffset);
}

function resize(event)
{
    layout();
}







function getAllNodesSimple(range)
{
    var result = new Array();
    var outermost = getOutermostNodesSimple(range);
    for (var i = 0; i < outermost.length; i++)
        addRecursive(outermost[i]);
    return result;

    function addRecursive(node)
    {
        result.push(node);
        for (var child = node.firstChild; child != null; child = child.nextSibling)
            addRecursive(child);
    }
}

function getNodeById(node,id)
{
    if (node._nodeId == id)
        return node;
    for (var child = node.firstChild; child != null; child = child.nextSibling) {
        var result = getNodeById(child,id);
        if (result != null)
            return result;
    }
    return null;
}

function testIsForwards()
{
    debug("");
    debug("Testing isForwards()");
    debug("--------------------");
    var startTime = new Date();
    var total = 0;
    var pass = 0;
    var fail = 0;
    for (var startIndex = 0; startIndex < allPositions.length; startIndex++) {
        for (var endIndex = 0; endIndex < allPositions.length; endIndex++) {
            var start = allPositions[startIndex];
            var end = allPositions[endIndex];
            var range = new Range(start.node,start.offset,end.node,end.offset);

            total++;

            var actual = range.isForwards();
            var expected = isForwardsSimple(range);
            if (actual == expected) {
                pass++;
            }
            else {
                debug("NOT OK: "+range+" (actual "+actual+", expected "+expected+")");
                fail++;
            }
        }
    }
    var endTime = new Date();
    debug("Test took "+(endTime-startTime)+"ms");
    debug("total "+total+", pass "+pass+", fail "+fail);
}

function arraysEqual(a,b)
{
    if (a.length != b.length)
        return false;

    for (var i = 0; i < a.length; i++) {
        if (a[i] != b[i])
            return false;
    }

    return true;
}

function testGetOutermostNodes()
{
    debug("");
    debug("Testing getOutermostNodes()");
    debug("--------------------");
    var startTime = new Date();
    var total = 0;
    var pass = 0;
    var fail = 0;

    window.rangeDebug = false;

//    for (var startIndex = 11; startIndex <= 11; startIndex++) {
//        for (var endIndex = 11; endIndex <= 11; endIndex++) {
    for (var startIndex = 0; startIndex < allPositions.length; startIndex++) {
        for (var endIndex = 0; endIndex < allPositions.length; endIndex++) {
            var start = allPositions[startIndex];
            var end = allPositions[endIndex];
            var range = new Range(start.node,start.offset,end.node,end.offset);

            total++;

            var info = new Object();
            var actual = range.getOutermostNodes(info);
            var expected = getOutermostNodesSimple(range);
            if (arraysEqual(actual,expected)) {
                pass++;
            }
            else {
                fail++;


                    var actualStrings = actual.map(function (node) { return node._nodeId; });
                    var expectedStrings = expected.map(function (node) { return node._nodeId; });
                    debug("NOT OK "+startIndex+"-"+endIndex+": "+range+
                          " (actual "+actualStrings+", expected "+expectedStrings+")");

                if (window.rangeDebug) {
                    var beginningStrings =
                        info.beginning.map(function (node) { return node._nodeId; });
                    var middleStrings = info.middle.map(function (node) { return node._nodeId; });
                    var endStrings = info.end.map(function (node) { return node._nodeId; });
                    debug("beginning = "+JSON.stringify(beginningStrings));
                    debug("middle = "+JSON.stringify(middleStrings));
                    debug("end = "+JSON.stringify(endStrings));
                }
            }
        }
    }
    var endTime = new Date();
    debug("Test took "+(endTime-startTime)+"ms");
    debug("total "+total+", pass "+pass+", fail "+fail);
}

function main()
{
    window.showIds = true;

    var root = document.getElementById("root");
    removeWhitespaceTextNodes(root);
    setup(root);


    var svg = document.createElementNS(SVG_NAMESPACE,"svg");
    svg.setAttribute("version","1.1");
    document.body.appendChild(svg);

    treeView = new TreeView(root);
//    treeView.labelFun = function(node) { return node._nodeId; }

    svg.appendChild(treeView.element);
    treeView.update();

    if (true) {
        treeView.selectionMode = TreeView.POSITION_SELECTION;
        treeView.onMouseDownPosition = mouseDownPosition;
        treeView.onMouseUpPosition = mouseUpPosition;
        treeView.onMouseOverPosition = mouseOverPosition;
    }
    else {
        treeView.onMouseDownNode = mouseDownNode;
        treeView.onMouseUpNode = mouseUpNode;
        treeView.onMouseOverNode = mouseOverNode;
    }

    UndoManager.monitorObject(state);
    window.onresize = resize;
    layout();

//    for (var i = 0; i < allPositions.length; i++)
//        debug("allPositions["+i+"] = "+allPositions[i]);
    debug("allPositions.length = "+allPositions.length);
    debug("root = "+nodeString(root));

/*
    var range = new Range(getNodeById(document,41),0,getNodeById(document,45),0);

    var actual = range.getOutermostNodes();
    var expected = getOutermostNodesSimple(range);

    debug("actual.length = "+actual.length);
    for (var i = 0; i < actual.length; i++)
        debug("actual["+i+"] = "+nodeString(actual[i]));
    debug("expected.length = "+expected.length);
    for (var i = 0; i < expected.length; i++)
        debug("expected["+i+"] = "+nodeString(expected[i]));
*/

    testIsForwards();
    testGetOutermostNodes();

}


</script>
</head>

<body onload="main()" style="margin: 0">

<div id="root" style="display: none">
    <div>
        <div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div>
            <div>One</div>
            <div>Two</div>
            <div></div>
        </div>
    </div>
    <div>
        <div>ONE</div>
        <div>TWO</div>
        <div>THREE</div>
    </div>
    <div>
        <div>
            <div></div>
            <div></div>
            <div></div>
        </div>
        <div>
            <div></div>
            <div></div>
        </div>
        <div>
            <div></div>
        </div>
    </div>
</div>

</body>
</html>
